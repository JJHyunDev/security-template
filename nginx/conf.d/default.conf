# Nginx Reverse Proxy Configuration
# Role: 클라이언트 요청을 Spring Boot로 전달하고, OAuth2 redirect URI가 올바르게 작동하도록 헤더 설정
# Complexity: Spring Security의 OAuth2 redirect URI 생성 시 Nginx 주소(http://localhost:80)를 기준으로
#             하도록 하려면 X-Forwarded-* 헤더를 정확히 전달해야 함

upstream spring-boot {
    # Docker Compose 내부 네트워크에서 Spring Boot 컨테이너로 연결
    # 여기서 spring-boot 는 그룹명
    server spring-boot:8080;
}

server {
    # 80포트로 들어오는 요청을 받겠다.
    listen 80;
    server_name localhost;

    # 클라이언트 최대 요청 크기 (필요시 조정)
    client_max_body_size 10M;

    location / {
        # Spring Boot로 프록시
        proxy_pass http://spring-boot;

        # 중요: OAuth2 redirect URI 생성을 위한 헤더 설정
        # Spring Boot가 클라이언트가 접근한 원본 호스트(localhost:80)를 인식하도록 함
        proxy_set_header Host $host;

        # 클라이언트의 실제 IP 주소 전달
        proxy_set_header X-Real-IP $remote_addr;

        # 프록시 체인의 모든 IP 주소 전달
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 원본 프로토콜(http/https) 전달 (http or https ://)
        # OAuth2 redirect URI 생성 시 http://localhost:80/login/oauth2/code/google 형태로 만들어짐
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 지원 (필요시)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
